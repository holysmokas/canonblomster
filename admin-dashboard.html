<!DOCTYPE html>
<html lang="da">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - Canon Blomster</title>
    <link rel="stylesheet" href="styles/main.css" />
</head>

<body>
    <header class="header-flex">
        <h1>üå∏ Produktstyring</h1>
        <button id="logoutBtn" class="logout-btn">Log ud</button>
    </header>

    <main class="dashboard-container">
        <button id="addProductBtn" class="add-btn">+ Tilf√∏j nyt produkt</button>

        <div id="productList" class="product-list"></div>

        <!-- Modal til produkt tilf√∏jelse -->
        <div id="productModal" class="modal" style="display:none;">
            <div class="modal-content">
                <h2>Tilf√∏j produkt</h2>
                <form id="productForm">
                    <input type="text" id="name" placeholder="Produktnavn" required />
                    <input type="text" id="description" placeholder="Beskrivelse" required />
                    <input type="text" id="category" placeholder="Kategori (fx: buket, plante)" required />
                    <input type="number" id="price" placeholder="Pris" required />
                    <input type="text" id="imageUrl" placeholder="Billede URL" required />
                    <button type="submit" class="save-btn">Gem</button>
                    <button type="button" id="closeModal" class="close-btn">Luk</button>
                </form>
            </div>
        </div>
    </main>

    <script type="module">
        import { auth, db } from "./scripts/firebase.js";
        import {
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import {
            collection,
            addDoc,
            deleteDoc,
            doc,
            onSnapshot
        } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        // ‚úÖ Check admin authentication
        onAuthStateChanged(auth, (user) => {
            if (!user || user.email !== "holysmokasthatscheap@gmail.com") {
                alert("‚õî Kun admin har adgang!");
                window.location.href = "admin-login.html";
            }
        });

        // ‚úÖ Logout
        document.getElementById("logoutBtn").addEventListener("click", async () => {
            await signOut(auth);
            window.location.href = "admin-login.html";
        });

        const productList = document.getElementById("productList");
        const modal = document.getElementById("productModal");
        const addProductBtn = document.getElementById("addProductBtn");
        const closeModal = document.getElementById("closeModal");
        const productForm = document.getElementById("productForm");

        // ‚úÖ Modal open/close
        addProductBtn.addEventListener("click", () => (modal.style.display = "block"));
        closeModal.addEventListener("click", () => (modal.style.display = "none"));

        // ‚úÖ Realtime product display
        onSnapshot(collection(db, "products"), (snapshot) => {
            productList.innerHTML = "";
            snapshot.forEach((docSnap) => {
                const data = docSnap.data();
                const card = document.createElement("div");
                card.classList.add("product-card");
                card.innerHTML = `
          <img src="${data.imageUrl}" alt="${data.name}" />
          <h3>${data.name}</h3>
          <p>${data.description}</p>
          <p><b>${data.price} kr</b></p>
          <button class="delete-btn" data-id="${docSnap.id}">Slet</button>
        `;
                productList.appendChild(card);
            });

            // ‚úÖ Delete product
            document.querySelectorAll(".delete-btn").forEach((btn) => {
                btn.addEventListener("click", async (e) => {
                    const id = e.target.dataset.id;
                    await deleteDoc(doc(db, "products", id));
                });
            });
        });

        // ‚úÖ Add new product
        productForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const name = document.getElementById("name").value.trim();
            const description = document.getElementById("description").value.trim();
            const category = document.getElementById("category").value.trim();
            const price = parseFloat(document.getElementById("price").value.trim());
            const imageUrl = document.getElementById("imageUrl").value.trim();

            if (!name || !description || !category || !price || !imageUrl) {
                alert("‚ö†Ô∏è Udfyld alle felter!");
                return;
            }

            try {
                await addDoc(collection(db, "products"), {
                    name,
                    description,
                    category,
                    price,
                    imageUrl,
                    createdAt: new Date().toISOString()
                });
                alert("‚úÖ Produkt tilf√∏jet!");
                productForm.reset();
                modal.style.display = "none";
            } catch (error) {
                console.error("Fejl ved tilf√∏jelse:", error);
                alert("‚õî Kun admin kan tilf√∏je produkter.");
            }
        });
    </script>
</body>

</html>